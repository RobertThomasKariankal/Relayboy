<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>RelayBoy Chat</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* Global */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Roboto', sans-serif;
    }

    body {
      background: #1a1a2e;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }

    /* Header */
    h1 {
      margin-bottom: 20px;
    }

    /* Layout */
    .container {
      display: flex;
      width: 100%;
      max-width: 1000px;
      height: 500px;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
    }

    /* Sidebar - Online Users */
    .users-box {
      width: 200px;
      background: #162447;
      padding: 15px;
      display: flex;
      flex-direction: column;
    }

    .users-box h3 {
      margin-bottom: 10px;
    }

    .online-users {
      list-style: none;
      flex: 1;
      overflow-y: auto;
    }

    .online-users li {
      padding: 10px;
      cursor: pointer;
      border-radius: 5px;
      margin-bottom: 5px;
      transition: 0.2s;
      display: flex;
      align-items: center;
    }

    .online-users li:hover {
      background: #1f4068;
    }

    .avatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: #e94560;
      display: inline-block;
      margin-right: 10px;
      text-align: center;
      line-height: 30px;
      font-weight: bold;
      color: #fff;
    }

    /* Chat Box */
    .chat-box {
      flex: 1;
      background: #1f2861;
      display: flex;
      flex-direction: column;
      padding: 15px;
      overflow-y: auto;
    }

    .message {
      margin-bottom: 10px;
      padding: 10px 15px;
      border-radius: 20px;
      max-width: 70%;
      word-wrap: break-word;
      display: inline-block;
    }

    .message.right {
      background: #e94560;
      color: #fff;
      align-self: flex-end;
      border-bottom-right-radius: 5px;
    }

    .message.left {
      background: #162447;
      color: #fff;
      align-self: flex-start;
      border-bottom-left-radius: 5px;
    }

    .timestamp {
      font-size: 0.7em;
      color: #ccc;
      margin-left: 5px;
    }

    /* Input Group */
    .input-group {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      width: 100%;
      max-width: 1000px;
    }

    input,
    button {
      padding: 10px;
      border-radius: 5px;
      border: none;
      outline: none;
    }

    input {
      flex: 1;
    }

    button {
      background: #e94560;
      color: #fff;
      cursor: pointer;
      transition: 0.2s;
    }

    button:hover {
      background: #d1344a;
    }

    #error {
      color: #ff5c5c;
      margin-top: 10px;
      text-align: center;
    }
  </style>
</head>

<body>

  <h1>RelayBoy Chat</h1>

  <!-- Chat UI Header -->
  <div
    style="display: flex; justify-content: space-between; align-items: center; width: 100%; max-width: 1000px; margin-bottom: 10px;">
    <div id="connection-status" style="font-size: 0.9rem; color: #888;">Connecting...</div>
    <button onclick="logout()"
      style="padding: 5px 15px; font-size: 0.8rem; background: transparent; border: 1px solid #e94560; color: #e94560;">Logout</button>
  </div>

  <div class="container">
    <div class="users-box">
      <h3>Online Users</h3>
      <ul id="users" class="online-users"></ul>
    </div>
    <div class="chat-box" id="chat"></div>
  </div>

  <div class="input-group" style="margin-top:10px;">
    <input id="msg" placeholder="Type your message" />
    <button onclick="send()">Send</button>
  </div>

  <script>
    let socket;
    let username;
    let currentChat = null;
    let chatHistory = {}; // per-user messages

    function connect() {
      username = localStorage.getItem('relayboy_username');
      if (!username) {
        window.location.href = 'login.html';
        return;
      }

      const statusBox = document.getElementById("connection-status");
      const token = localStorage.getItem('relayboy_token');

      if (!token) {
        window.location.href = 'login.html';
        return;
      }

      const protocol = window.location.hostname === "localhost" ? "ws" : "wss";
      socket = new WebSocket(`${protocol}://${window.location.host}`);

      socket.onopen = () => {
        socket.send(JSON.stringify({ type: "register", username, token }));
        statusBox.textContent = "Connected as " + username;
        statusBox.style.color = "#4fd1c5";
      };

      socket.onmessage = (e) => {
        const data = JSON.parse(e.data);

        if (data.type === "error") {
          alert(data.message);
          localStorage.removeItem('relayboy_username');
          window.location.href = 'login.html';
        }

        if (data.type === "users") {
          const usersDiv = document.getElementById("users");
          usersDiv.innerHTML = "";
          data.users.filter(u => u !== username).forEach(u => {
            const li = document.createElement("li");
            li.innerHTML = `<span class="avatar">${u.charAt(0).toUpperCase()}</span>${u}`;
            li.onclick = () => openChat(u);
            usersDiv.appendChild(li);
          });
        }

        if (data.type === "message") {
          if (!chatHistory[data.from]) chatHistory[data.from] = [];
          chatHistory[data.from].push({ from: data.from, message: data.message, timestamp: data.timestamp });
          if (currentChat === data.from) renderChat(currentChat);
        }
      };
    }

    function openChat(user) {
      currentChat = user;
      if (!chatHistory[user]) chatHistory[user] = [];
      renderChat(user);
    }

    function send() {
      const msgInput = document.getElementById("msg");
      const msg = msgInput.value.trim();
      if (!msg || !currentChat) return;

      socket.send(JSON.stringify({ type: "message", to: currentChat, message: msg }));

      if (!chatHistory[currentChat]) chatHistory[currentChat] = [];
      chatHistory[currentChat].push({ from: username, message: msg, timestamp: new Date().toLocaleTimeString() });
      renderChat(currentChat);

      msgInput.value = "";
    }

    function renderChat(user) {
      const chat = document.getElementById("chat");
      chat.innerHTML = "";
      chatHistory[user].forEach(msg => {
        const div = document.createElement("div");
        div.className = "message " + (msg.from === username ? "right" : "left");
        div.innerHTML = msg.message + `<span class="timestamp"> [${msg.timestamp}]</span>`;
        chat.appendChild(div);
      });
      chat.scrollTop = chat.scrollHeight;
    }

    function logout() {
      localStorage.removeItem('relayboy_username');
      localStorage.removeItem('relayboy_token');
      window.location.href = 'login.html';
    }

    // Auto-connect on load
    window.onload = connect;

    document.getElementById("msg").addEventListener("keydown", (e) => {
      if (e.key === "Enter") send();
    });
  </script>
</body>

</html>